name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "üîç CI Diagnostics"
        run: |
          echo "=== Environment ==="
          echo "Python Version: $(python --version)"
          echo "Pip Version: $(pip --version)"
          echo ""
          echo "=== Project Structure (*.py files) ==="
          find src -type d -name "__pycache__" -prune -o -type f -name "*.py" -print | head -20
          echo ""

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff black

      - name: Run Ruff + Black (capture logs)
        continue-on-error: true
        run: |
          set +e
          echo "=== Running Ruff ===" > ${{ github.workspace }}/lint.log
          ruff check src/ tests/ >> ${{ github.workspace }}/lint.log 2>&1
          echo "$?" > ${{ github.workspace }}/ruff.exitcode
          echo "" >> ${{ github.workspace }}/lint.log
          echo "=== Running Black ===" >> ${{ github.workspace }}/lint.log
          black --check src/ tests/ >> ${{ github.workspace }}/lint.log 2>&1
          echo "$?" > ${{ github.workspace }}/black.exitcode
          set -e

      - name: Upload lint log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-log
          path: lint.log
          retention-days: 30

      - name: Fail job if lint errors were found
        if: always()
        run: |
          set -euo pipefail
          ruff_ec="$(cat "${{ github.workspace }}/ruff.exitcode" 2>/dev/null || echo 0)"
          black_ec="$(cat "${{ github.workspace }}/black.exitcode" 2>/dev/null || echo 0)"

          # Guard clauses: se algum comando retornou erro, falha o job (mantendo o log j√° enviado).
          if [ "${ruff_ec}" -ne 0 ] || [ "${black_ec}" -ne 0 ]; then
            echo "‚ùå Lint falhou (ruff=${ruff_ec}, black=${black_ec}). Veja o artifact lint-log."
            exit 1
          fi

          # Fallback: se por algum motivo n√£o capturamos exit codes, tenta detectar erros pelo log.
          if grep -Eiq "(Found [1-9][0-9]* error|error:|E\\d{3})" "${{ github.workspace }}/lint.log"; then
            echo "‚ùå Poss√≠veis erros detectados no lint.log. Veja o artifact lint-log."
            exit 1
          fi

          echo "‚úÖ Lint OK."

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy pandas-stubs types-requests

      - name: Run Mypy (capture logs)
        continue-on-error: true
        run: |
          set +e
          mypy src/grimperium --ignore-missing-imports > ${{ github.workspace }}/type.log 2>&1
          echo "$?" > ${{ github.workspace }}/mypy.exitcode
          set -e

      - name: Upload type log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: type-log
          path: type.log
          retention-days: 30

      - name: Fail job if typecheck errors were found
        if: always()
        run: |
          set -euo pipefail
          mypy_ec="$(cat "${{ github.workspace }}/mypy.exitcode" 2>/dev/null || echo 0)"
          if [ "${mypy_ec}" -ne 0 ]; then
            echo "‚ùå Type check falhou (mypy=${mypy_ec}). Veja o artifact type-log."
            exit 1
          fi
          if grep -Eiq "\\berror:\\b" "${{ github.workspace }}/type.log"; then
            echo "‚ùå Poss√≠veis erros detectados no type.log. Veja o artifact type-log."
            exit 1
          fi
          echo "‚úÖ Type check OK."

  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root

      - name: Install project
        run: poetry install --no-interaction

      - name: Run tests (capture logs)
        run: |
          poetry run pytest tests/ -v --cov=src/grimperium --cov-report=xml --tb=short > ${{ github.workspace }}/test-${{ matrix.python-version }}.log 2>&1

      - name: Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-log-${{ matrix.python-version }}
          path: test-${{ matrix.python-version }}.log
          retention-days: 30

      - name: Upload coverage
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Build package
        run: poetry build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  report:
    name: "üìä CI Error Summary"
    runs-on: ubuntu-latest
    if: always()
    needs: [lint, typecheck, test, build]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download log artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*-log*"
          path: ${{ github.workspace }}/logs

      - name: List downloaded artifacts
        run: |
          echo "=== Downloaded Artifacts ==="
          ls -R ${{ github.workspace }}/logs

      - name: Generate CI Report
        run: python .github/scripts/generate_ci_report.py
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_STEP_SUMMARY: ${{ env.GITHUB_STEP_SUMMARY }}

      - name: Upload comprehensive report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: CI-Error-Summary-Report
          path: CI_ERROR_SUMMARY.md
          retention-days: 30

      - name: Display report
        if: always()
        run: |
          echo "=========================================="
          echo "CI Error Summary Report Generated:"
          echo "=========================================="
          cat CI_ERROR_SUMMARY.md

      - name: Check for failures
        if: always() && (needs.lint.result == 'failure' || needs.typecheck.result == 'failure' || needs.test.result == 'failure')
        run: |
          echo "‚ùå CI checks failed. See report above for details."
          exit 1
