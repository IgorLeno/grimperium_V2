name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "ðŸ” CI Diagnostics"
        run: |
          echo "=== Environment ==="
          echo "Python Version: $(python --version)"
          echo "Pip Version: $(pip --version)"
          echo ""
          echo "=== Project Structure (*.py files) ==="
          find src -type d -name "__pycache__" -prune -o -type f -name "*.py" -print | head -20
          echo ""

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff black

      - name: Run ruff
        run: ruff check src/ tests/

      - name: Run black
        run: black --check src/ tests/

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy pandas-stubs types-requests

      - name: Run mypy
        run: mypy src/grimperium --ignore-missing-imports

  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root

      - name: Install project
        run: poetry install --no-interaction

      - name: Run tests
        run: poetry run pytest tests/ -v --cov=src/grimperium --cov-report=xml

      - name: Upload coverage
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Build package
        run: poetry build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  error-summary:
    name: "ðŸ“Š Error Summary"
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, build]
    if: always() && (needs.lint.result == 'failure' || needs.typecheck.result == 'failure' || needs.test.result == 'failure' || needs.build.result == 'failure')
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install dependencies
        run: poetry install --with dev --no-interaction

      - name: "ðŸ“Š Generate CI Error Summary"
        run: |
          # Initialize report
          cat > CI_ERROR_SUMMARY.md << 'HEADER'
          # CI Error Summary Report

          HEADER

          echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> CI_ERROR_SUMMARY.md
          echo "**Commit:** ${{ github.sha }}" >> CI_ERROR_SUMMARY.md
          echo "**Branch:** ${{ github.ref_name }}" >> CI_ERROR_SUMMARY.md
          echo "**Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> CI_ERROR_SUMMARY.md
          echo "" >> CI_ERROR_SUMMARY.md
          echo "---" >> CI_ERROR_SUMMARY.md
          echo "" >> CI_ERROR_SUMMARY.md

          # Track failure status
          LINT_FAILED=false
          TYPE_FAILED=false
          TEST_FAILED=false

          # Section 1: Lint Errors (Ruff)
          echo "## 1ï¸âƒ£ Lint Errors (Ruff)" >> CI_ERROR_SUMMARY.md
          echo "" >> CI_ERROR_SUMMARY.md

          if poetry run ruff check src/ tests/ 2>&1 | tee /tmp/ruff.log; then
            echo "âœ… **Status: PASSED**" >> CI_ERROR_SUMMARY.md
          else
            LINT_FAILED=true
            echo "âŒ **Status: FAILED**" >> CI_ERROR_SUMMARY.md
            echo "" >> CI_ERROR_SUMMARY.md
            echo "<details>" >> CI_ERROR_SUMMARY.md
            echo "<summary>Show errors</summary>" >> CI_ERROR_SUMMARY.md
            echo "" >> CI_ERROR_SUMMARY.md
            echo '```' >> CI_ERROR_SUMMARY.md
            cat /tmp/ruff.log >> CI_ERROR_SUMMARY.md
            echo '```' >> CI_ERROR_SUMMARY.md
            echo "</details>" >> CI_ERROR_SUMMARY.md
          fi
          echo "" >> CI_ERROR_SUMMARY.md

          # Section 1b: Black formatting
          echo "## 1ï¸âƒ£b Format Check (Black)" >> CI_ERROR_SUMMARY.md
          echo "" >> CI_ERROR_SUMMARY.md

          if poetry run black --check src/ tests/ 2>&1 | tee /tmp/black.log; then
            echo "âœ… **Status: PASSED**" >> CI_ERROR_SUMMARY.md
          else
            LINT_FAILED=true
            echo "âŒ **Status: FAILED**" >> CI_ERROR_SUMMARY.md
            echo "" >> CI_ERROR_SUMMARY.md
            echo "<details>" >> CI_ERROR_SUMMARY.md
            echo "<summary>Show formatting issues</summary>" >> CI_ERROR_SUMMARY.md
            echo "" >> CI_ERROR_SUMMARY.md
            echo '```' >> CI_ERROR_SUMMARY.md
            cat /tmp/black.log >> CI_ERROR_SUMMARY.md
            echo '```' >> CI_ERROR_SUMMARY.md
            echo "</details>" >> CI_ERROR_SUMMARY.md
          fi
          echo "" >> CI_ERROR_SUMMARY.md

          # Section 2: Type Errors (Mypy)
          echo "## 2ï¸âƒ£ Type Check Errors (Mypy)" >> CI_ERROR_SUMMARY.md
          echo "" >> CI_ERROR_SUMMARY.md

          if poetry run mypy src/grimperium --ignore-missing-imports 2>&1 | tee /tmp/mypy.log; then
            echo "âœ… **Status: PASSED**" >> CI_ERROR_SUMMARY.md
          else
            TYPE_FAILED=true
            echo "âŒ **Status: FAILED**" >> CI_ERROR_SUMMARY.md
            echo "" >> CI_ERROR_SUMMARY.md
            echo "<details>" >> CI_ERROR_SUMMARY.md
            echo "<summary>Show type errors</summary>" >> CI_ERROR_SUMMARY.md
            echo "" >> CI_ERROR_SUMMARY.md
            echo '```' >> CI_ERROR_SUMMARY.md
            grep -E "error:" /tmp/mypy.log | head -50 >> CI_ERROR_SUMMARY.md || true
            echo '```' >> CI_ERROR_SUMMARY.md
            echo "" >> CI_ERROR_SUMMARY.md
            MYPY_COUNT=$(grep -c "error:" /tmp/mypy.log || echo "0")
            echo "**Total errors:** $MYPY_COUNT" >> CI_ERROR_SUMMARY.md
            echo "</details>" >> CI_ERROR_SUMMARY.md
          fi
          echo "" >> CI_ERROR_SUMMARY.md

          # Section 3: Test Errors (Pytest)
          echo "## 3ï¸âƒ£ Test Errors (Pytest)" >> CI_ERROR_SUMMARY.md
          echo "" >> CI_ERROR_SUMMARY.md

          if poetry run pytest tests/ -v --tb=short 2>&1 | tee /tmp/pytest.log; then
            echo "âœ… **Status: PASSED**" >> CI_ERROR_SUMMARY.md
          else
            TEST_FAILED=true
            echo "âŒ **Status: FAILED**" >> CI_ERROR_SUMMARY.md
            echo "" >> CI_ERROR_SUMMARY.md
            echo "<details>" >> CI_ERROR_SUMMARY.md
            echo "<summary>Show test failures</summary>" >> CI_ERROR_SUMMARY.md
            echo "" >> CI_ERROR_SUMMARY.md
            echo '```' >> CI_ERROR_SUMMARY.md
            grep -E "FAILED|ERROR|ModuleNotFoundError|ImportError|AssertionError" /tmp/pytest.log | head -30 >> CI_ERROR_SUMMARY.md || true
            echo "" >> CI_ERROR_SUMMARY.md
            echo "--- Short Traceback ---" >> CI_ERROR_SUMMARY.md
            grep -A 5 "FAILED\|ERROR" /tmp/pytest.log | head -50 >> CI_ERROR_SUMMARY.md || true
            echo '```' >> CI_ERROR_SUMMARY.md
            echo "</details>" >> CI_ERROR_SUMMARY.md
          fi
          echo "" >> CI_ERROR_SUMMARY.md

          # Summary table
          echo "---" >> CI_ERROR_SUMMARY.md
          echo "" >> CI_ERROR_SUMMARY.md
          echo "## ðŸ“Š Summary" >> CI_ERROR_SUMMARY.md
          echo "" >> CI_ERROR_SUMMARY.md
          echo "| Check | Status | Job Result |" >> CI_ERROR_SUMMARY.md
          echo "|-------|--------|------------|" >> CI_ERROR_SUMMARY.md

          if [ "$LINT_FAILED" = true ]; then
            echo "| Lint (Ruff/Black) | âŒ FAILED | ${{ needs.lint.result }} |" >> CI_ERROR_SUMMARY.md
          else
            echo "| Lint (Ruff/Black) | âœ… PASSED | ${{ needs.lint.result }} |" >> CI_ERROR_SUMMARY.md
          fi

          if [ "$TYPE_FAILED" = true ]; then
            echo "| Type Check (Mypy) | âŒ FAILED | ${{ needs.typecheck.result }} |" >> CI_ERROR_SUMMARY.md
          else
            echo "| Type Check (Mypy) | âœ… PASSED | ${{ needs.typecheck.result }} |" >> CI_ERROR_SUMMARY.md
          fi

          if [ "$TEST_FAILED" = true ]; then
            echo "| Tests (Pytest) | âŒ FAILED | ${{ needs.test.result }} |" >> CI_ERROR_SUMMARY.md
          else
            echo "| Tests (Pytest) | âœ… PASSED | ${{ needs.test.result }} |" >> CI_ERROR_SUMMARY.md
          fi

          echo "| Build | - | ${{ needs.build.result }} |" >> CI_ERROR_SUMMARY.md
          echo "" >> CI_ERROR_SUMMARY.md

          # Final status
          if [ "$LINT_FAILED" = true ] || [ "$TYPE_FAILED" = true ] || [ "$TEST_FAILED" = true ]; then
            echo "### âŒ Overall: FAILED" >> CI_ERROR_SUMMARY.md
          else
            echo "### âœ… Overall: PASSED (job failures may be transient)" >> CI_ERROR_SUMMARY.md
          fi
          echo "" >> CI_ERROR_SUMMARY.md

          # Display generated report
          echo "=========================================="
          echo "CI Error Summary Report Generated:"
          echo "=========================================="
          cat CI_ERROR_SUMMARY.md

      - name: "ðŸ“¦ Upload Error Summary"
        uses: actions/upload-artifact@v4
        with:
          name: CI-Error-Summary-${{ github.run_number }}
          path: CI_ERROR_SUMMARY.md
          retention-days: 30

      - name: "ðŸ“‹ Post Summary to Job"
        run: cat CI_ERROR_SUMMARY.md >> $GITHUB_STEP_SUMMARY
