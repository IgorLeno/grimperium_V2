# CREST Integration in Grimperium

## Overview

**Program:** CREST (Conformer-Rotamer Ensemble Sampling Tool)
**Version:** 3.0.2 (November 2025)
**Role:** Conformational sampling driver for xTB
**Method:** iMTD-GC (iterated Meta-Dynamics with Genetic Crossing)
**Language:** Fortran (semiempirical tight-binding methods)

CREST is a driver program for the xTB (extended tight-binding) quantum chemistry
package, developed by the Grimme group at the University of Bonn. It provides
robust and efficient conformational sampling for molecules of moderate size
(typically up to 200-300 atoms).

---

## What is CREST?

CREST = **C**onformer-**R**otamer **E**nsemble **S**ampling **T**ool

### Purpose

CREST explores the conformational space of molecules to find:
- **Global minimum:** The lowest energy conformer
- **Local minima:** Other stable conformations
- **Rotamer distribution:** Different rotational isomers

### Key Features

1. **iMTD-GC Algorithm:** Combines metadynamics-based exploration with genetic
   crossing for efficient sampling
2. **xTB Integration:** Uses GFN2-xTB or GFN-FF force fields for fast energy
   evaluations
3. **Automated Workflow:** No manual setup of collective variables required
4. **Deduplication:** Automatic removal of duplicate conformers via RMSD and
   energy criteria
5. **Clustering:** Groups similar conformers for cleaner output

### Comparison with Other Methods

| Method | Speed | Thoroughness | Best For |
|--------|-------|--------------|----------|
| CREST iMTD-GC | Fast | Very Good | Medium molecules (20-200 atoms) |
| Systematic Search | Slow | Complete | Small molecules (<20 atoms) |
| MD Annealing | Medium | Good | Large molecules (>200 atoms) |
| Basin Hopping | Medium | Moderate | Metal clusters |

---

## Phase A Workflow in Grimperium

### Input
- SMILES string (molecular structure)
- 3D geometry (generated by RDKit/MMFF)

### Process

```
Step 1: SMILES → 3D Geometry
    ├── RDKit parses SMILES
    ├── MMFF94 force field embedding
    └── Initial geometry optimization

Step 2: CREST Conformational Sampling
    ├── xTB-based metadynamics
    ├── Genetic crossing of conformers
    ├── Energy optimization (GFN2-xTB)
    └── Clustering and deduplication

Step 3: Conformer Selection
    ├── Sort by energy (lowest first)
    ├── Apply energy window filter
    └── Select top N conformers

Step 4: Output
    ├── Best conformer XYZ file
    ├── Full ensemble (if requested)
    └── Energy rankings
```

### Output

- `crest_best.xyz`: Best (lowest energy) conformer
- `crest_conformers.xyz`: Full conformer ensemble
- `crest.energies`: Relative energies in kcal/mol
- `crest.out`: Detailed execution log

---

## Critical Keywords

### Essential Keywords for Grimperium

| Keyword | Default | Effect | Grimperium Setting |
|---------|---------|--------|-------------------|
| `--v3` | OFF | Use iMTD-GC v3 algorithm | **ON (default)** |
| `--quick` | OFF | Quick mode (less thorough) | **ON** |
| `--scratch <DIR>` | `./tmpdir` | Working directory | `/dev/shm/crest_<ID>` |
| `--T <N>` | auto | Number of threads | **4** |
| `--ewin <KCAL>` | 6.0 | Energy window (kcal/mol) | **6.0** |
| `--rthr <ANG>` | 0.125 | RMSD threshold | **0.125** |
| `--ethr <KCAL>` | 0.05 | Energy threshold | **0.05** |
| `--optlev <LV>` | tight | Optimization level | **vtight** |

### Quick Mode (`--quick`)

Quick mode reduces computational cost by:
- Shorter MD simulation time
- Fewer metadynamics iterations
- Faster convergence criteria

**Trade-off:** May miss some conformers, but significantly faster.

**Grimperium uses quick mode** because:
1. Processing 30k+ molecules requires efficiency
2. Delta-learning will correct remaining errors
3. PM7 single-point is the final step (conformer refinement less critical)

### Scratch Directory (`--scratch`)

CREST creates many temporary files during execution. Using a fast scratch
directory significantly improves performance.

```bash
# Best: RAM disk (Linux only)
--scratch /dev/shm/crest_${MOL_ID}

# Good: Local SSD
--scratch /tmp/crest_${MOL_ID}

# Avoid: Network drives (NFS, SMB)
# These cause massive slowdowns due to I/O latency
```

### Threading (`--T`)

CREST parallelizes across conformer optimizations.

```bash
# For 4-CPU machine
--T 4

# For 8-CPU machine (leave some for system)
--T 6

# Guideline: Use 80-90% of available CPUs
```

**Note:** Using more threads than CPU cores provides no benefit and may cause
slowdowns due to context switching.

### Energy Window (`--ewin`)

Conformers within this energy window (in kcal/mol) of the global minimum are
kept.

```
--ewin 6.0   # Default, keeps conformers ≤6 kcal/mol above minimum
--ewin 10.0  # Broader, more conformers (slower)
--ewin 3.0   # Narrower, fewer conformers (faster)
```

**6.0 kcal/mol is a good balance** - captures thermally accessible conformers
at room temperature (~2 kT margin).

### RMSD Threshold (`--rthr`)

Conformers closer than this RMSD (in Ångströms) are considered duplicates.

```
--rthr 0.125  # Default, strict deduplication
--rthr 0.200  # Looser, fewer unique conformers
--rthr 0.075  # Stricter, more unique conformers (slower)
```

### Optimization Level (`--optlev`)

Controls geometry optimization precision.

```
loose   - Fast, low precision
normal  - Standard
tight   - Good precision
vtight  - Very tight (used in Grimperium)
extreme - Maximum precision (very slow)
```

**vtight is recommended** for thermochemistry applications where accurate
geometries matter.

---

## Advanced Keywords

### Constraint Options

```bash
# Fix specific atoms
--constrain atoms:1-5

# Apply distance constraint
--constrain distance:1,2,1.5

# Freeze dihedral angle
--constrain dihedral:1,2,3,4,180
```

### Force Field Selection

```bash
# Default: GFN2-xTB (accurate)
crest molecule.xyz

# GFN-FF (faster, less accurate)
crest molecule.xyz --gfnff

# GFN1-xTB (older method)
crest molecule.xyz --gfn1
```

**When to use GFN-FF:**
- Very large molecules (>100 heavy atoms)
- Rapid screening (accuracy less critical)
- Molecules with unusual elements

### NCI Mode for Complexes

For molecular complexes (non-covalently bound):

```bash
crest complex.xyz --nci
```

This preserves the intermolecular geometry while sampling conformations.

---

## CREST Output Structure

### Directory Layout

```
scratch_dir/
├── crest.out           # Main execution log
├── crest_best.xyz      # Lowest energy conformer
├── crest_conformers.xyz # Full ensemble
├── crest.energies      # Energy list
├── coord               # Final coordinates (Turbomole format)
├── wbo                 # Wiberg bond orders
└── xtb.out             # xTB detailed output
```

### Output File Formats

**crest_best.xyz:**
```xyz
15
 energy: -12.345678 H
 C     0.000000    0.000000    0.000000
 C     1.540000    0.000000    0.000000
 ...
```

**crest.energies:**
```
     1      -12.34567800    0.000     !best
     2      -12.34456700    0.291
     3      -12.34345600    0.582
     ...
```

### Interpreting crest.out

Key sections to look for:

1. **Input summary:** Confirms molecule was read correctly
2. **MTD settings:** Shows metadynamics parameters
3. **GC info:** Genetic crossing rounds
4. **Final ensemble:** Number of unique conformers
5. **Best structure:** Final global minimum

---

## Error Handling

### Exit Code 0: Success

CREST completed normally. Check `crest_best.xyz` for results.

### Exit Code 156 (Not Officially Documented)

This is the most common error in Grimperium batch processing.

**What it means:**
- xTB subprocess failed during execution
- Not a specific CREST error - wrapper exit code
- Actual cause is hidden in `crest.out`

**Common Causes:**

1. **Geometry degeneracy:**
   - Atoms too close together
   - Linear molecule with numerical instabilities
   - Solution: Better initial geometry generation

2. **SCF convergence failure:**
   - Electronic structure not converging
   - Often with exotic elements or high charges
   - Solution: Check SMILES validity, element support

3. **Energy NaN/Inf:**
   - Numerical overflow in energy calculation
   - Usually from bad geometry
   - Solution: Validate input geometry

4. **File I/O error:**
   - Disk full
   - Permission issues
   - Network drive timeout
   - Solution: Check disk space, use local scratch

5. **MD instability:**
   - Metadynamics run became unstable
   - Molecule fragmented during simulation
   - Solution: Use `--wall` constraint or shorter runs

**Debugging Strategy:**

```bash
# Check last 100 lines of crest.out for error
tail -100 crest.out | grep -i "error\|fail\|abnormal\|nan\|inf"

# Look for xTB-specific errors
grep -i "scf\|convergence\|gradient" crest.out
```

### Timeout Error

**Causes:**
- Molecule very flexible (many rotatable bonds)
- Hardware too slow
- Scratch disk bottleneck

**Solutions:**
1. Increase timeout value
2. Move scratch to SSD/RAM disk
3. Use `--quick` mode
4. Pre-optimize geometry before CREST

### Memory Errors

**Causes:**
- Very large molecule
- Too many conformers generated
- System memory exhausted

**Solutions:**
1. Use `--gfnff` for large molecules
2. Reduce `--ewin` to generate fewer conformers
3. Increase system swap space (not recommended)

---

## Boron, Phosphorus, Arsenic, Germanium Problem

### The Issue

MMFF94 force field (used by RDKit for 3D geometry generation) has limited or
no parameters for certain elements:
- **Boron (B):** Partial support
- **Phosphorus (P):** Limited support
- **Arsenic (As):** No support
- **Germanium (Ge):** No support

**Result:** Initial geometry may be unreliable, causing CREST to fail.

### Impact on Grimperium

```
Original dataset:  30,026 molecules
  - Contains B:    242 molecules (0.8%)
  - Contains P:    198 molecules (0.7%)
  - Contains As:   3 molecules (<0.1%)
  - Contains Ge:   16 molecules (<0.1%)

CHON-only dataset: 29,568 molecules (1.5% loss)
```

### Solution: CHON-Only Dataset (Phase A)

For Phase A, we use a filtered dataset containing only:
- **C** (Carbon)
- **H** (Hydrogen)
- **O** (Oxygen)
- **N** (Nitrogen)

**Benefits:**
- 100% MMFF compatibility
- Reliable geometry generation
- >99% expected success rate

### Solution: GFN-FF Mode (Phase B - Future)

For Phase B or production, handle exotic elements with GFN-FF:

```python
def select_force_field(smiles: str) -> str:
    """Select appropriate force field based on elements."""
    exotic_elements = {"B", "P", "As", "Ge", "Se", "Si"}
    mol = Chem.MolFromSmiles(smiles)

    for atom in mol.GetAtoms():
        if atom.GetSymbol() in exotic_elements:
            return "--gfnff"  # Use GFN force field

    return ""  # Use default GFN2-xTB
```

---

## Best Practices for Batch Processing

### 1. Scratch Directory Setup

```bash
# Create RAM disk scratch (requires root or pre-configured)
mkdir -p /dev/shm/crest_work

# Set permissions
chmod 777 /dev/shm/crest_work

# In Python code
scratch_dir = Path(f"/dev/shm/crest_work/mol_{mol_id}_{uuid()[:8]}")
```

### 2. Parallelization Strategy

**Molecule-level parallelization:**
- Process one molecule at a time (current Grimperium approach)
- Simple, avoids resource conflicts
- Use CREST's internal threading

**Process-level parallelization (future):**
- Run multiple CREST processes simultaneously
- Requires careful thread management
- Can achieve 2-4x speedup on multi-CPU machines

### 3. Timeout Strategy

**Conservative (recommended for production):**
```python
crest_timeout = 20  # minutes
# Most molecules finish in <10 min
# Allows for complex molecules
# Reduces unnecessary failures
```

**Aggressive (for rapid screening):**
```python
crest_timeout = 5  # minutes
# Fail fast on problematic molecules
# Higher skip rate (~5-10%)
# Faster overall throughput
```

### 4. Error Recovery

```python
def process_molecule(mol_id, smiles, config):
    """Process with error recovery."""
    try:
        result = run_crest(mol_id, smiles, config)
        if result.status == CRESTStatus.SUCCESS:
            return result
    except CRESTTimeout:
        # Mark for retry with longer timeout
        return mark_for_retry(mol_id, "timeout")
    except CRESTError as e:
        if "error 156" in str(e):
            # Likely geometry issue - skip
            return mark_skip(mol_id, "geometry_error")
        else:
            # Unknown error - log and skip
            logger.error(f"CREST failed for {mol_id}: {e}")
            return mark_skip(mol_id, str(e))
```

### 5. Monitoring

Track these metrics during batch processing:
- Success rate (target: >95%)
- Average execution time
- Timeout rate (target: <5%)
- Error distribution by type

---

## Integration with Grimperium

### Configuration (PM7Config)

CREST settings are configured through the PM7Config dataclass:

```python
@dataclass
class PM7Config:
    # CREST settings
    crest_executable: str = "crest"
    crest_timeout: float = 300.0  # seconds (default: 5 min)
    energy_window: float = 6.0    # kcal/mol
    max_conformers: int = 10

    # Optimization level
    optlev: str = "vtight"
```

### Conformer Generator Module

Location: `src/grimperium/crest_pm7/conformer_generator.py`

```python
def run_crest(
    mol_id: str,
    input_xyz: Path,
    config: PM7Config,
    smiles: str,
) -> CRESTResult:
    """
    Execute CREST conformational sampling.

    Args:
        mol_id: Molecule identifier
        input_xyz: Input XYZ file with initial geometry
        config: PM7 configuration with CREST settings
        smiles: SMILES string (for xyz-to-sdf conversion)

    Returns:
        CRESTResult with conformer files and status
    """
    ...
```

### ProcessorAdapter Module

Location: `src/grimperium/crest_pm7/batch/processor_adapter.py`

Handles timeout conversion and batch-level configuration:

```python
class FixedTimeoutProcessor:
    """Process molecules with fixed timeouts."""

    def __init__(
        self,
        config: PM7Config,
        crest_timeout_minutes: float = 30.0,
        mopac_timeout_minutes: float = 60.0,
    ) -> None:
        # Convert minutes to seconds for CREST
        config.crest_timeout = crest_timeout_minutes * 60
        ...
```

### Performance Expectations

**Typical molecule (MW ~200, CHON-only):**
- CREST time: 2-5 minutes
- Conformers found: 3-10
- Success rate: >99%

**Complex molecule (MW >300, flexible):**
- CREST time: 5-10 minutes
- Conformers found: 10-50
- Success rate: ~95%

**Very flexible molecule (many rotatable bonds):**
- CREST time: 10-20 minutes (may timeout)
- Conformers found: 50-200
- Consider: Pre-filtering or longer timeout

---

## Troubleshooting Guide

### Problem: Low Success Rate (<90%)

**Possible Causes:**
1. CREST timeout too short
2. Dataset contains problematic elements
3. Scratch disk too slow
4. Hardware resource contention

**Solutions:**
```bash
# Increase timeout
crest_timeout = 30  # minutes

# Check for non-CHON elements
python scripts/filter_chon_only.py dataset.csv --analyze

# Use faster scratch
--scratch /dev/shm/crest_work
```

### Problem: Very Slow Execution (>10 min/molecule)

**Possible Causes:**
1. Scratch disk on slow storage
2. Too many threads competing
3. Large/flexible molecules
4. Memory swapping

**Solutions:**
```bash
# Move to SSD/RAM scratch
export CREST_SCRATCH=/dev/shm

# Reduce thread count
--T 2

# Use quick mode
--quick
```

### Problem: "xtb terminated abnormally"

**Causes:**
- Bad input geometry
- Disk full
- Memory exhausted

**Solutions:**
```bash
# Check disk space
df -h /dev/shm /tmp

# Check memory
free -h

# Validate input
python -c "from rdkit import Chem; print(Chem.MolFromSmiles('$SMILES'))"
```

### Problem: Reproducibility Issues

**Causes:**
- Random number generator seeding
- Thread scheduling differences
- Floating-point precision

**Solutions:**
```bash
# Set random seed (CREST 3.0+)
--seed 42

# Consistent threading
--T 4  # Fixed number
```

---

## References

### Official Documentation

- [CREST Documentation](https://crest-lab.github.io/crest-docs/) - Official CREST docs
- [xTB Documentation](https://xtb-docs.readthedocs.io/) - xTB method details
- [CREST GitHub](https://github.com/crest-lab/crest) - Source code and issues

### Key Publications

1. Pracht, P.; Bohle, F.; Grimme, S. *Phys. Chem. Chem. Phys.* **2020**, 22,
   7169-7192. "Automated exploration of the low-energy chemical space with
   fast quantum chemical methods"

2. Grimme, S. *J. Chem. Theory Comput.* **2019**, 15, 2847-2862. "Exploration
   of Chemical Compound, Conformer, and Reaction Space with Meta-Dynamics
   Simulations Based on Tight-Binding Quantum Chemical Calculations"

3. Bannwarth, C.; et al. *J. Chem. Theory Comput.* **2019**, 15, 1652-1671.
   "GFN2-xTB—An Accurate and Broadly Parametrized Self-Consistent Tight-Binding
   Quantum Chemical Method"

### Related Grimperium Documentation

- [MOPAC Integration](./MOPAC_INTEGRATION.md) - PM7 single-point calculations
- [Workflow Documentation](./WORKFLOW.md) - Full pipeline description

---

## Appendix: CREST Command-Line Reference

### Basic Usage

```bash
# Standard conformer search
crest molecule.xyz

# Quick mode
crest molecule.xyz --quick

# With specific scratch directory
crest molecule.xyz --scratch /dev/shm/work --T 4
```

### Full Option List (Commonly Used)

```bash
--version, -v      Print version information
--help, -h         Print help message

# Algorithm Control
--v3               Use iMTD-GC v3 algorithm (recommended)
--quick            Quick mode (faster, less thorough)
--nci              NCI mode for molecular complexes

# Force Field Selection
--gfn2             Use GFN2-xTB (default)
--gfnff            Use GFN force field
--gfn1             Use GFN1-xTB

# Conformer Parameters
--ewin <KCAL>      Energy window for conformer selection
--rthr <ANG>       RMSD threshold for deduplication
--ethr <KCAL>      Energy threshold for deduplication

# Resource Control
--T <N>            Number of threads
--scratch <DIR>    Scratch directory

# Optimization
--optlev <LEVEL>   Optimization level (loose/normal/tight/vtight/extreme)

# Output
--ensemble         Save full conformer ensemble
--niceprint        Show progress bar
```

---

**Last Updated:** 2026-01-15
**Version:** Phase A
**Grimperium Version:** 0.2.0
